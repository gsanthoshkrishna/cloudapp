<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Images with Persistent Properties Display</title>
    <style>
        #image-container,
        #drop-container {
            border: 2px dashed #aaa;
            padding: 20px;
            margin: 20px;
            min-height: 100px;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
        }

        img {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            cursor: pointer;
        }

        .selected {
            border: 2px solid blue;
        }

        #properties-container {
            display: none;
            border: 2px dashed #aaa;
            padding: 20px;
            margin: 20px;
            min-height: 100px;
        }
    </style>
</head>
<body>

<div id="image-container">
    {% for imge in resources %}
        <img src="/static/{{ imge.image }}" draggable="true" ondragstart="drag(event)" alt="{{ imge.id }}">
    {% endfor %}
</div>

<div id="drop-container" ondrop="drop(event)" ondragover="allowDrop(event)">
    Drop Here
</div>

<div id="properties-container">
    <div id="image-properties"></div>
</div>

<script>
let currentImage = null;

document.addEventListener('keydown', function(event) {
    if (event.key === 'Delete' && currentImage) {
        currentImage.parentElement.removeChild(currentImage);
        document.getElementById('properties-container').style.display = 'none';
        currentImage = null;
    }
});

document.addEventListener('click', function(event) {
    const propertiesContainer = document.getElementById('properties-container');
    const dropContainer = document.getElementById('drop-container');
    
    if (!propertiesContainer.contains(event.target) && (!currentImage || !currentImage.contains(event.target))) {
        propertiesContainer.style.display = 'none';
        if (currentImage) {
            currentImage.classList.remove('selected');
        }
        currentImage = null;
    }
});

function allowDrop(event) {
    event.preventDefault();
}

function drag(event) {
    event.dataTransfer.setData("text", event.target.src);
    event.dataTransfer.setData("alt", event.target.alt);
}

function drop(event) {
    event.preventDefault();
    var data = event.dataTransfer.getData("text");
    var altText = event.dataTransfer.getData("alt");

    var wrapper = document.createElement('div');
    wrapper.className = 'image-wrapper';

    var img = new Image();
    img.src = data;
    img.alt = altText;
    img.style.maxWidth = "100px";
    img.style.maxHeight = "100px";
    img.style.margin = "5px";
    img.style.cursor = "pointer";
    img.onclick = function() {
        if (currentImage) {
            currentImage.classList.remove('selected');
        }
        img.classList.toggle('selected');
        currentImage = img.classList.contains('selected') ? img : null;
        displayProperties(currentImage);
    };
    wrapper.appendChild(img);

    document.getElementById('drop-container').appendChild(wrapper);
}

function displayProperties(img) {
    if (img) {
        document.getElementById('properties-container').style.display = 'block';
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/get_properties', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                let propertiesDiv = document.getElementById('image-properties');
                propertiesDiv.innerHTML = ''; // Clear previous properties
                data.forEach(prop => {
                    let propDiv = document.createElement('div');
                    let inputElement;
                    switch(prop.prop_input_type) {
                        case 'textbox':
                            inputElement = `<input type="text" name="${prop.prop_name}" ${prop.is_mandatory == 'yes' ? 'required' : ''}>`;
                            break;
                        case 'dropdown':
                            inputElement = `<select name="${prop.prop_name}" ${prop.is_mandatory == 'yes' ? 'required' : ''}><option value="">Select</option></select>`;
                            break;
                        case 'checkbox':
                            inputElement = `<input type="checkbox" name="${prop.prop_name}" ${prop.is_mandatory == 'yes' ? 'required' : ''}>`;
                            break;
                        case 'radio':
                            inputElement = `<input type="radio" name="${prop.prop_name}" ${prop.is_mandatory == 'yes' ? 'required' : ''}>`;
                            break;
                        default:
                            inputElement = `<input type="text" name="${prop.prop_name}" ${prop.is_mandatory == 'yes' ? 'required' : ''}>`;
                    }
                    propDiv.innerHTML = `<strong>${prop.prop_name}:</strong> ${inputElement}`;
                    propertiesDiv.appendChild(propDiv);
                });
            }
        };
        xhr.send('resource_id=' + encodeURIComponent(img.alt));
    } else {
        document.getElementById('properties-container').style.display = 'none';
    }
}
</script>

</body>
</html>